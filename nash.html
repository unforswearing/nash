<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nash : Note as HTML</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%22%20height%3D%22100%22%20viewBox%3D%220%200%20100%20100%22%3E%0A%20%20%3Crect%20width%3D%22100%22%20height%3D%22100%22%20rx%3D%2220%22%20fill%3D%22black%22%2F%3E%0A%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2260%22%20font-weight%3D%22bold%22%20text-anchor%3D%22middle%22%20fill%3D%22white%22%20font-family%3D%22Arial%2C%20sans-serif%22%20dominant-baseline%3D%22central%22%3EN.%3C%2Ftext%3E%0A%3C%2Fsvg%3E">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      margin: 0;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .editor-container {
      width: 100%;
      max-width: 800px;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.1);
    }

    .file-title {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 15px;
      padding: 0px 15px;
      outline: none;
      border: none;
      width: 100%;
      background: transparent;
    }

    .file-title:empty::before {
      content: "Write your title here...";
      color: #bbb;
      display: block;
    }

    #toolbar {
      position: sticky;
      position: -webkit-sticky;
      gap: 8px;
      top: 5px;
      padding: 0 10px;
      z-index: 9999;
      background-color: #f8f9fa;
      border-radius: 12px;
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      align-items: center;
    }

    #toolbar #splitbar {
      margin-left: auto;
    }

    #toolbar input[type="file"] {
      display: none;
    }


    #toolbar button,
    #toolbar label,
    #toolbar select {
      padding: 8px;
      border: none;
      background: none;
      font-size: 16px;
      cursor: pointer;
      transition: opacity 0.2s
    }

    #toolbar button:hover,
    #toolbar label:hover,
    #toolbar select:hover {
      background: #f0f0f0;
      border-color: #bbb;
    }

    /* Dropdown container */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    /* Dropdown button style */
    .dropdown>button {
      padding: 6px 10px;
    }

    /* Dropdown content (hidden by default) */
    .dropdown-content {
      display: none;
      position: absolute;
      top: 110%;
      left: 0;
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      z-index: 10;
    }

    /* Show dropdown when .show is added */
    .dropdown-content.show {
      display: block;
    }

    /* Grid of swatches */
    .swatch-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 24px);
      gap: 6px;
    }

    .color-swatch {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .color-swatch:hover {
      transform: scale(1.1);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
    }

    /* Ìé∏Ïßë ÏòÅÏó≠ */
    #editor {
      border-radius: 12px;
      padding: 15px;
      min-height: 250px;
      outline: none;
      font-size: 16px;
      line-height: 1.6;
      /* background: #f4f4f4; */
    }

    #editor p {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }

    #editor a {
      color: #616161;
      text-decoration: none;
      font-weight: 800;
      transition: all 0.2s ease-in-out;
      border-bottom: 2px solid transparent;
    }

    #editor a:hover {
      border-bottom: 2px solid #616161;
      color: #616161;
    }

    #editor a::before {
      content: "üîó";
    }


    #editor:empty::before,
    #editor p:empty::before {
      content: "Write your note here...";
      color: #bbb;
      display: block;
    }

    #footer {
      text-align: center;
      margin-top: 20px;
      color: #bbb;
    }

    #footer a {
      text-decoration: none;
      color: #bbb;
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px 0;
      border-radius: 12px;
    }

    .thin-line::before {
      content: "";
      display: block;
      width: 100%;
      height: 1px;
      background-color: #ddd;
      margin: 10px 0;
    }

    @media print {
      .no-print {
        display: none !important;
      }

      .editor-container {
        width: 100%;
        max-width: 100%;
        box-shadow: none;
      }
    }
  </style>
</head>

<body>

  <div class="editor-container">
    <div id="filename" contenteditable="plaintext-only" class="file-title"></div>

    <div id="toolbar" class="no-print">
      <button onclick="changeBlock('h1')">XL</button>
      <button onclick="changeBlock('h2')">L</button>
      <button onclick="changeBlock('p')">M</button>
      <button onclick="changeBlock('small')">S</button>

      <button onclick="applyFormat('strong')"><b>B</b></button>
      <button onclick="applyFormat('em')"><i>I</i></button>
      <button onclick="applyFormat('u')"><u>U</u></button>
      <button onclick="applyURL()">üîó</button>

      <label for="imageUpload">üì∑</label>
      <input type="file" id="imageUpload" accept="image/*" onchange="insertImage(event)">

      <div class="dropdown">
        <button onclick="toggleDropdown('textColorDropdown')">Color</button>
        <div id="textColorDropdown" class="dropdown-content">
          <div class="swatch-grid">
            <button class="color-swatch" style="background: #000000;" onmousedown="event.preventDefault();"
              onclick="applyTextColor('#000000'); toggleDropdown('textColorDropdown')"></button>
            <button class="color-swatch" style="background: #FF3B30;" onmousedown="event.preventDefault();"
              onclick="applyTextColor('#FF3B30'); toggleDropdown('textColorDropdown')"></button>
            <button class="color-swatch" style="background: #FF9500;" onmousedown="event.preventDefault();"
              onclick="applyTextColor('#FF9500'); toggleDropdown('textColorDropdown')"></button>
            <button class="color-swatch" style="background: #FFCC00;" onmousedown="event.preventDefault();"
              onclick="applyTextColor('#FFCC00'); toggleDropdown('textColorDropdown')"></button>
            <button class="color-swatch" style="background: #4CD964;" onmousedown="event.preventDefault();"
              onclick="applyTextColor('#4CD964'); toggleDropdown('textColorDropdown')"></button>
            <button class="color-swatch" style="background: #5AC8FA;" onmousedown="event.preventDefault();"
              onclick="applyTextColor('#5AC8FA'); toggleDropdown('textColorDropdown')"></button>
            <button class="color-swatch" style="background: #007AFF;" onmousedown="event.preventDefault();"
              onclick="applyTextColor('#007AFF'); toggleDropdown('textColorDropdown')"></button>
            <button class="color-swatch" style="background: #5856D6;" onmousedown="event.preventDefault();"
              onclick="applyTextColor('#5856D6'); toggleDropdown('textColorDropdown')"></button>
          </div>
        </div>
      </div>

      <!-- Highlight Color Dropdown -->
      <div class="dropdown">
        <button onclick="toggleDropdown('highlightDropdown')">Highlight</button>
        <div id="highlightDropdown" class="dropdown-content">
          <div class="swatch-grid">
            <button class="color-swatch" style="background: #FCECEC;" onmousedown="event.preventDefault();"
              onclick="applyHighlightColor('#FCECEC'); toggleDropdown('highlightDropdown')"></button>
            <button class="color-swatch" style="background: #FFECEB;" onmousedown="event.preventDefault();"
              onclick="applyHighlightColor('#FFECEB'); toggleDropdown('highlightDropdown')"></button>
            <button class="color-swatch" style="background: #FFF8E1;" onmousedown="event.preventDefault();"
              onclick="applyHighlightColor('#FFF8E1'); toggleDropdown('highlightDropdown')"></button>
            <button class="color-swatch" style="background: #F1FAE5;" onmousedown="event.preventDefault();"
              onclick="applyHighlightColor('#F1FAE5'); toggleDropdown('highlightDropdown')"></button>
            <button class="color-swatch" style="background: #E6F9F0;" onmousedown="event.preventDefault();"
              onclick="applyHighlightColor('#E6F9F0'); toggleDropdown('highlightDropdown')"></button>
            <button class="color-swatch" style="background: #E8F0FE;" onmousedown="event.preventDefault();"
              onclick="applyHighlightColor('#E8F0FE'); toggleDropdown('highlightDropdown')"></button>
            <button class="color-swatch" style="background: #E7F0FF;" onmousedown="event.preventDefault();"
              onclick="applyHighlightColor('#E7F0FF'); toggleDropdown('highlightDropdown')"></button>
            <button class="color-swatch" style="background: #F3E8FF;" onmousedown="event.preventDefault();"
              onclick="applyHighlightColor('#F3E8FF'); toggleDropdown('highlightDropdown')"></button>
          </div>
        </div>
      </div>

      <div id="splitbar">|</div>
      <!-- Block conversion -->
      <button onclick="exportToFile(true)">üì• Save</button>
      <button onclick="exportToFile(false)">üì§ Share</button>
    </div>

    <div id="editorContainer" class="thin-line">
      <div id="editor" contenteditable="true">
        <p></p>
      </div>
    </div>

    <div id="footer">
      <small><a href="https://github.com/keepworking/nash">nash@github</a></small>
    </div>
  </div>

  <script>

    async function exportToFile(save) {
      let filename = document.getElementById("filename").innerText.trim();
      if (!filename) {
        alert("tilte is empty!");
        return;
      }

      filename = filename.endsWith(".html") ? filename : filename + ".html";

      let content = document.documentElement.outerHTML;
      let blob = new Blob(["<!DOCTYPE html>\n" + content], { type: "text/html" });
      let file = new File([blob], filename, { type: "text/html" });

      if (save == false && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: filename,
            text: null
          });
        } catch (error) {
          console.error("share failed:", error);
        }
      } else {
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      }
    }

    function insertImage(event) {
      let file = event.target.files[0];
      if (file) {
        let reader = new FileReader();
        reader.onload = function (e) {
          let img = document.createElement("img");
          img.src = e.target.result;
          document.querySelector("#editor").appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    }

    // Toggle dropdown visibility
    function toggleDropdown(id) {
      const dropdown = document.getElementById(id);
      if (dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
      } else {
        // Close any open dropdowns first
        document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('show'));
        dropdown.classList.add('show');
      }
    }

    // Close dropdowns if clicking outside
    document.addEventListener('click', function (e) {
      if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('show'));
      }
    });

    // Helper: Place the caret at a given element and offset.
    function setCaret(el, pos) {
      const selection = window.getSelection();
      const range = document.createRange();
      range.setStart(el, pos);
      range.collapse(true);
      selection.removeAllRanges();
      selection.addRange(range);
    }

    // Wrap only the selected portions of text nodes.
    // If selection is entirely within one text node, process it directly.
    function wrapRangeText(range, tagName, style, hook) {
      const textNodes = [];
      if (range.commonAncestorContainer.nodeType === Node.TEXT_NODE) {
        textNodes.push(range.commonAncestorContainer);
      } else {
        const walker = document.createTreeWalker(
          range.commonAncestorContainer,
          NodeFilter.SHOW_TEXT,
          {
            acceptNode: function (node) {
              return range.intersectsNode(node)
                ? NodeFilter.FILTER_ACCEPT
                : NodeFilter.FILTER_REJECT;
            }
          }
        );
        let node;
        while (node = walker.nextNode()) {
          textNodes.push(node);
        }
      }

      textNodes.forEach(function (textNode) {
        let start = 0, end = textNode.textContent.length;
        if (textNode === range.startContainer) {
          start = range.startOffset;
        }
        if (textNode === range.endContainer) {
          end = range.endOffset;
        }
        if (start >= end) return;

        const parent = textNode.parentNode;
        const wrapper = document.createElement(tagName);
        if (style) {
          wrapper.style.cssText = style;
        }
        if (hook) {
          hook(wrapper);
        }
        wrapper.textContent = textNode.textContent.substring(start, end);

        const frag = document.createDocumentFragment();
        const beforeText = textNode.textContent.substring(0, start);
        const afterText = textNode.textContent.substring(end);
        if (beforeText) {
          frag.appendChild(document.createTextNode(beforeText));
        }
        frag.appendChild(wrapper);
        if (afterText) {
          frag.appendChild(document.createTextNode(afterText));
        }
        parent.replaceChild(frag, textNode);
      });
    }

    // Basic inline formatting: wraps the selection in the specified tag.
    function applyFormat(tagName) {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) return;
      const range = selection.getRangeAt(0);
      const editor = document.getElementById('editor');
      if (!editor.contains(range.commonAncestorContainer)) return;
      wrapRangeText(range, tagName);
      selection.removeAllRanges();
    }

    // Apply inline style (e.g., font-size, text color, background color) by wrapping the selection in a <span>.
    function applyStyle(styleString) {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) return;
      const range = selection.getRangeAt(0);
      const editor = document.getElementById('editor');
      if (!editor.contains(range.commonAncestorContainer)) return;
      wrapRangeText(range, 'span', styleString);
      selection.removeAllRanges();
    }

    // Apply inline url 
    function applyURL() {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) return;
      const range = selection.getRangeAt(0);
      const editor = document.getElementById('editor');
      if (!editor.contains(range.commonAncestorContainer)) return;
      const url = prompt("URL");
      if (!url) return;
      wrapRangeText(range, 'a', null, function (element) {
        element.href = url;
      });
      selection.removeAllRanges();
    }

    // Called by the text size dropdown.
    function applyTextSize(size) {
      if (!size) return;
      applyStyle("font-size: " + size + ";");
    }

    // Called when a text color swatch is clicked.
    function applyTextColor(color) {
      if (!color) return;
      applyStyle("color: " + color + ";");
    }

    // Called when a highlight (background color) swatch is clicked.
    function applyHighlightColor(color) {
      if (!color) return;
      applyStyle("background-color: " + color + ";");
    }

    // Convert the current block (direct child of #editor) to the chosen tag.
    function changeBlock(tag) {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      let node = selection.anchorNode;
      const editor = document.getElementById('editor');
      while (node && node.parentNode !== editor) {
        node = node.parentNode;
      }
      if (!node || node === editor) return;
      const newBlock = document.createElement(tag);
      while (node.firstChild) {
        if (
          node.firstChild.nodeType === Node.ELEMENT_NODE &&
          node.firstChild.matches('p') &&
          tag.match(/^H[1-6]$/)
        ) {
          let child = node.firstChild;
          while (child.firstChild) {
            newBlock.appendChild(child.firstChild);
          }
          node.removeChild(child);
        } else {
          newBlock.appendChild(node.firstChild);
        }
      }
      editor.replaceChild(newBlock, node);
      const range = document.createRange();
      range.selectNodeContents(newBlock);
      range.collapse(false);
      selection.removeAllRanges();
      selection.addRange(range);
    }

    // Splits the current block at the caret.
    function splitBlock() {
      const editor = document.getElementById('editor');
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);

      let block = range.startContainer;
      while (block && block.parentNode !== editor) {
        block = block.parentNode;
      }
      if (!block) {
        const p = document.createElement('p');
        p.innerHTML = '<br>';
        editor.appendChild(p);
        setCaret(p, 0);
        return;
      }

      const afterRange = range.cloneRange();
      afterRange.setStart(range.endContainer, range.endOffset);
      afterRange.setEndAfter(block.lastChild || block);
      const afterContent = afterRange.cloneContents();

      const isAtEnd = !Array.from(afterContent.childNodes).some(n => {
        return (n.nodeType === Node.ELEMENT_NODE) ||
          (n.nodeType === Node.TEXT_NODE && n.textContent.trim());
      });

      if (isAtEnd) {
        const newBlock = document.createElement('p');
        newBlock.innerHTML = '<br>';
        if (block.nextSibling) {
          editor.insertBefore(newBlock, block.nextSibling);
        } else {
          editor.appendChild(newBlock);
        }
        setCaret(newBlock, 0);
      } else {
        const newBlock = document.createElement('p');
        const extractRange = range.cloneRange();
        extractRange.setEndAfter(block.lastChild || block);
        const extracted = extractRange.extractContents();
        if (!extracted.childNodes.length) {
          newBlock.innerHTML = '<br>';
        } else {
          newBlock.appendChild(extracted);
        }
        if (block.nextSibling) {
          editor.insertBefore(newBlock, block.nextSibling);
        } else {
          editor.appendChild(newBlock);
        }
        setCaret(newBlock, 0);
      }

      if (!block.textContent.trim() && !block.querySelector('img, video, iframe, embed, object')) {
        block.innerHTML = '<br>';
      }
    }

    // Normalize stray text nodes and nested blocks.
    function normalizeEditor() {
      const editor = document.getElementById('editor');
      Array.from(editor.childNodes).forEach(node => {
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
          const p = document.createElement('p');
          p.textContent = node.textContent;
          editor.replaceChild(p, node);
        }
      });
      editor.querySelectorAll('p p, h1 p, h2 p, h3 p, h4 p, h5 p, h6 p, p font, small p').forEach(nested => {
        const parent = nested.parentNode;
        while (nested.firstChild) {
          parent.insertBefore(nested.firstChild, nested);
        }
        parent.removeChild(nested);
      });
    }


    // Normalize stray text nodes and nested blocks.
    function cleanEditor() {
      const editor = document.getElementById('editor');
      if (editor.firstChild && ["H1", "H2", "H3", "H4", "H5", "H6", "P"].includes(editor.firstChild.nodeName)) {
        return;
      }
      if (editor.innerHTML.trim() === "" || editor.innerHTML.trim() === "<br>") {
        editor.innerHTML = "<p></p>";
      }
    }

    function updateTitle() {
      let filename = document.getElementById("filename").innerHTML.trim();
      document.title = filename || "Nash : Note as HTML";
    }

    function keydownHandler(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        splitBlock();
      }
      if ((e.ctrlKey || e.metaKey) && (e.key === 'z' || e.key === 'y')) {
        e.preventDefault();
      }
    }

    function clickHandler(e) {
      const target = e.target.closest("a");
      if (!target || !document.getElementById("editorContainer").contains(target)) return;

      e.preventDefault();

      const userConfirmed = confirm(`"${target.href}" open this url?`);
      if (userConfirmed) {
        window.open(target.href, "_blank");
      }
    }


    editor = document.getElementById('editor');
    filename = document.getElementById('filename');

    editor.addEventListener('keydown', keydownHandler);
    editor.addEventListener('click', clickHandler);
    editor.addEventListener('blur', normalizeEditor);
    editor.addEventListener("input", cleanEditor);
    editor.addEventListener("focus", cleanEditor);

    filename.addEventListener("input", updateTitle);

    updateTitle();

  </script>

</body>

</html>